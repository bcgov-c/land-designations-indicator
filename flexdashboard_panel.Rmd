---
title: "Land Designations Indicator"
output: 
  flexdashboard::flex_dashboard:
    theme:
      bg: "white"
      fg: "black" 
      primary: "#66ABCA"
      base_font:
        google: Prompt
      code_font:
        google: JetBrains Mono
    orientation: columns
    vertical_layout: fill
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
library(flexdashboard)
library(tidyverse)
library(sf)
library(crosstalk)
library(leaflet)
# library(leaflet.extras)
library(plotly)
library(envreportutils)
library(ggpubr)
library(magick)
library(jpeg)
library(bslib)
rm(list = ls())
```

```{r load_data}
bc_regs_each_r_level = read_sf('tmp/bc_regdists.gpkg') %>% 
  st_transform(crs = 3005) %>% 
  mutate(key = paste(industry_name, ADMIN_AREA_NAME, max_restriction_value, sep = '_'))

bc_regs_wide = bc_regs_each_r_level %>% 
  dplyr::select(industry_name, ADMIN_AREA_NAME, max_restriction_value, prop_regdist_area) %>% 
  mutate(max_restriction_value = paste0('max_restriction_',max_restriction_value)) %>% 
  spread(key = max_restriction_value, value = prop_regdist_area)

bc_regs_just_geometries = bc_regs_each_r_level %>% 
  dplyr::select(industry_name, ADMIN_AREA_NAME, max_restriction_value, key) %>% 
  distinct()

bc_regs_just_values = bc_regs_each_r_level %>% 
  st_drop_geometry()

# bc_regs_each_r_level %>% 
#   group_by(industry_name, ADMIN_AREA_NAME) %>% 
#   
#   slice_head(n = 1)
# 
# bc_regs = bc_regs %>% mutate(my_key = paste0(industry_name,ADMIN_AREA_NAME,max_restriction_value))
```

```{r load_in_provincial_summary_jpegs}
main_plot_f = image_read('out/forest_restriction_plot.jpeg') %>% 
  image_scale("x800") 
# image_crop('900x700+0+250')

main_plot_m = image_read('out/mine_restriction_plot.jpeg') %>% 
  image_scale("x800")
# image_crop('900x700+0+250')

main_plot_og = image_read('out/og_restriction_plot.jpeg') %>% 
  image_scale("x800")
# image_crop('900x700+0+250')

# main_barplot_f = image_read('out/forestry_barplot.png') %>% 
# image_convert(format = 'jpeg') %>% 
# image_scale("x600")

# image_for_mosaic_f = c(main_plot_f,main_barplot_f)
# image_append(image_for_mosaic_f,stack=T)
```

```{r establish_crosstalk_shared_data_environments}
# shared_dat_f = crosstalk::SharedData$new(bc_regs %>% filter(industry_name == "forest_restriction_max"), key = ~my_key, group = 'all')
# 
# shared_dat_m = crosstalk::SharedData$new(bc_regs %>% filter(industry_name == "mine_restriction_max"), key = ~my_key)
# 
# shared_dat_og = crosstalk::SharedData$new(bc_regs %>% filter(industry_name == "og_restriction_max"), key = ~my_key)
# 
# shared_images_f = crosstalk::SharedData$new(bc_regs %>%
#                                               dplyr::select(my_key,image_path) %>%
#                                               st_drop_geometry(),
#                                             key = ~my_key)
```

## Column {.tabset}

```{=html}
<p align="center",fontsize='20',fontweight='bold'>
Provincial Figures
</p>
```

### Forestry

```{r}
main_plot_f
```

### Mining

```{r}
main_plot_m
```

### Oil and Gas

```{r}
main_plot_og
```

## Column {.tabset}

### Forestry

```{r}
bc_regs_f = bc_regs_each_r_level %>% 
  st_transform(4326) %>% 
  filter(industry_name == "forest_restriction_max")

my_popups_f = bc_regs_f %>% 
  filter(max_restriction_value == 0) %>% 
  mutate(my_popup = paste0("<img src = './tmp/regdist_svgs/forest_restriction_max_",ADMIN_AREA_NAME,".svg'{width='300'}>")) %>% 
  pull(my_popup)

my_pal = leaflet::colorNumeric(palette = 'viridis', 
                               domain = bc_regs_f$prop_regdist_area)
l = leaflet()

for(i in c(0:5)){
  l = l %>% 
    addPolygons(data = bc_regs_f %>% filter(max_restriction_value == i), 
                color = 'black',
                weight = 3,
                highlightOptions = highlightOptions(color = '#FDE725', 
                                                    weight = 6),
                label = ~paste0(ADMIN_AREA_NAME,": ",100*round(prop_regdist_area,2),"%"),
                fillColor = ~my_pal(prop_regdist_area),
                fill = T,
                fillOpacity = 1,
                popup = my_popups_f,
                popupOptions = popupOptions(minWidth = 300),
                group = ~paste0("Max Restriction Level ",i))
}

l %>% 
  addProviderTiles(provider = 'Stamen.TerrainBackground') %>% 
  envreportutils::add_bc_home_button() %>% 
  envreportutils::set_bc_view() %>% 
  addLayersControl(baseGroups = paste0("Max Restriction Level ",c(0:5)),
                   options = layersControlOptions(collapsed = F)) %>% 
  addLegend(position = 'bottomright',
            pal = my_pal,
            values = c(bc_regs_f$prop_regdist_area))
```

### Mining

```{r}
bc_regs_m = bc_regs_each_r_level %>% 
  st_transform(4326) %>% 
  filter(industry_name == "mine_restriction_max")

my_popups_m = bc_regs_m %>% 
  filter(max_restriction_value == 0) %>% 
  mutate(my_popup = paste0("<img src = './tmp/regdist_svgs/mine_restriction_max_",ADMIN_AREA_NAME,".svg'{width='300'}>")) %>% 
  pull(my_popup)

my_pal = leaflet::colorNumeric(palette = 'viridis', 
                               domain = bc_regs_m$prop_regdist_area)
l = leaflet()

for(i in c(0:5)){
  l = l %>% 
    addPolygons(data = bc_regs_m %>% filter(max_restriction_value == i), 
                color = 'black',
                weight = 3,
                highlightOptions = highlightOptions(color = '#FDE725', 
                                                    weight = 6),
                label = ~paste0(ADMIN_AREA_NAME,": ",100*round(prop_regdist_area,2),"%"),
                fillColor = ~my_pal(prop_regdist_area),
                fill = T,
                fillOpacity = 1,
                popup = my_popups_m,
                popupOptions = popupOptions(minWidth = 300),
                group = ~as.character(paste0("Max Restriction Level ",i)))
}

l %>% 
  addProviderTiles(provider = 'Stamen.TerrainBackground') %>% 
  envreportutils::add_bc_home_button() %>% 
  envreportutils::set_bc_view() %>% 
  addLayersControl(baseGroups = paste0("Max Restriction Level ",c(0:5)),
                   options = layersControlOptions(collapsed = F)) %>% 
  addLegend(position = 'bottomright',
            pal = my_pal,
            values = c(bc_regs_m$prop_regdist_area))
```

### Oil and Gas

```{r}
bc_regs_og = bc_regs_each_r_level %>% 
  st_transform(4326) %>% 
  filter(industry_name == "og_restriction_max")

my_popups_og = bc_regs_og %>% 
  filter(max_restriction_value == 0) %>% 
  mutate(my_popup = paste0("<img src = './tmp/regdist_svgs/og_restriction_max_",ADMIN_AREA_NAME,".svg'{width='300'}>")) %>% 
  pull(my_popup)

my_pal = leaflet::colorNumeric(palette = 'viridis', 
                               domain = bc_regs_og$prop_regdist_area)
l = leaflet()

for(i in c(0:5)){
  l = l %>% 
    addPolygons(data = bc_regs_og %>% filter(max_restriction_value == i), 
                color = 'black',
                weight = 3,
                highlightOptions = highlightOptions(color = '#FDE725', 
                                                    weight = 6),
                label = ~paste0(ADMIN_AREA_NAME,": ",100*round(prop_regdist_area,2),"%"),
                fillColor = ~my_pal(prop_regdist_area),
                fill = T,
                fillOpacity = 1,
                popup = my_popups_og,
                popupOptions = popupOptions(minWidth = 300),
                group = ~as.character(paste0("Max Restriction Level ",i)))
}

l %>% 
  addProviderTiles(provider = 'Stamen.TerrainBackground') %>% 
  envreportutils::add_bc_home_button() %>% 
  envreportutils::set_bc_view() %>% 
  addLayersControl(baseGroups = paste0("Max Restriction Level ",c(0:5)),
                   options = layersControlOptions(collapsed = F)) %>% 
  addLegend(position = 'bottomright',
            pal = my_pal,
            values = c(bc_regs_og$prop_regdist_area))
```

### Barplots

```{=html}
<p align="center",fontsize='20',fontweight='bold'>
Regional Districts
</p>
```
```{r regional_district_plot_plus_linked_histogram}
#Set up reactive, shared data environment.
bc_regs_for_plotly <- crosstalk::SharedData$new(bc_regs_wide)
# bc_regs_for_plotly <- crosstalk::SharedData$new(bc_regs_each_r_level)
# bc_regs_for_plotly_long <- crosstalk::SharedData$new(bc_regs_each_r_level, key = 'key', group = 'all')

# # Make a crosstalk filter for max restriction value.
# max_rlevel_selector = filter_select(
#   id = 'max_restriction_level_slider',
#   label = 'Restriction Level',
#   sharedData = bc_regs_for_plotly,
#   group = ~max_restriction_value,
#   multiple = F
# )

# initiate a plotly object
base <- bc_regs_for_plotly %>%
  plotly::plotly_empty()
# highlight(
#   on = 'plotly_click',
#   off = 'plotly_doubleclick',
#   opacityDim = 0.5
# )

ggmap_plot = ggplot() +
  geom_sf(data = bc_regs_for_plotly,
          fill = 'grey') +
  ggthemes::theme_map()
ggmap_plot = ggplotly(ggmap_plot, tooltip = 'ADMIN_AREA_NAME') %>% 
  layout(autosize = F, width = 700, height = 700)

# highlight(
#   on = 'plotly_click',
#   off = 'plotly_doubleclick',
#   opacityDim = 0.5
# )

# plotly_map = base %>%
#   # group_by(key) %>%
#   # add_scattergeo() %>%
#   highlight(
#     on = 'plotly_click',
#     off = 'plotly_doubleclick',
#     opacityDim = 0.5
#   )

plotly_barplot = bc_regs_for_plotly %>%
  plot_ly(
    transforms = list(
      list(
        type = 'aggregate',
        groups = ~max_restriction_5,
        aggregations = list(
          list(
            target = 'x', func = 'sum', enabled = T
          )
        )
      )
    )
  ) %>%
  add_bars(x = ~max_restriction_0, y = 0, orientation = 'h', text = '', opacity = 0) %>%
  add_bars(x = ~max_restriction_1, y = 1, orientation = 'h', text = '', opacity = 0) %>%
  add_bars(x = ~max_restriction_2, y = 2, orientation = 'h', text = '', opacity = 0) %>%
  add_bars(x = ~max_restriction_3, y = 3, orientation = 'h', text = '', opacity = 0) %>%
  add_bars(x = ~max_restriction_4, y = 4, orientation = 'h', text = '', opacity = 0) %>%
  add_bars(x = ~max_restriction_5, y = 5, orientation = 'h', text = '', opacity = 0) %>% 
  layout(
    yaxis = list(title = list(
      text = "Max Restriction Level",
      font = list(size = 20))
    ),
    xaxis = list(title = list(
      text = "Proportion of Regional District Area (%)",
      font = list(size = 20))
    ),
    showlegend = FALSE,
    autosize = F,
    width = 500, height = 700
  )

# plotly_barplot
# ggplot_barplot = bc_regs_for_plotly %>% 
#   ggplot() + 
#   geom_col(aes(x = max_restriction_value, y = prop_regdist_area)) + 
#   coord_flip() + 
#   scale_x_continuous(breaks = c(0:5)) + 
#   labs(y = "Proportional Area of Regional District",
#        x = "Maximum Restriction Level")
# 
# plotly_barplot = ggplotly(ggplot_barplot) %>% 
#   layout(
#     opacity = 0
#   )

subplot(ggmap_plot, plotly_barplot, nrows = 2
) %>%
  plotly::config(displayModeBar = F) %>% 
  layout(barmode = "overlay", showlegend = FALSE) %>%
  highlight(
    dynamic = TRUE,
    selectize = F,
    selected = attrs_selected(opacity = 1),
    color = 'rgba(152,78,163,1)'
  )
```
