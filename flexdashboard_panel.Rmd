---
title: "Themed dashboard"
output: 
  flexdashboard::flex_dashboard:
    theme:
      bg: "white"
      fg: "black" 
      primary: "#66ABCA"
      base_font:
        google: Prompt
      code_font:
        google: JetBrains Mono
    orientation: columns
    vertical_layout: fill
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
library(flexdashboard)
library(tidyverse)
library(sf)
library(crosstalk)
library(leaflet)
# library(leaflet.extras)
library(plotly)
library(envreportutils)
library(ggpubr)
library(magick)
library(jpeg)
library(bslib)
rm(list = ls())
```

```{r load_data}
bc_regs_each_r_level = read_sf('tmp/bc_regdists.gpkg') %>% 
  st_transform(crs = 3005) %>% 
  mutate(key = paste(industry_name, ADMIN_AREA_NAME, max_restriction_value, sep = '_'))

bc_regs_wide = bc_regs_each_r_level %>% 
  dplyr::select(industry_name, ADMIN_AREA_NAME, max_restriction_value, prop_regdist_area) %>% 
  mutate(max_restriction_value = paste0('max_restriction_',max_restriction_value)) %>% 
  spread(key = max_restriction_value, value = prop_regdist_area)

bc_regs_just_geometries = bc_regs_each_r_level %>% 
  dplyr::select(industry_name, ADMIN_AREA_NAME, max_restriction_value, key) %>% 
  distinct()

bc_regs_just_values = bc_regs_each_r_level %>% 
  st_drop_geometry()

# bc_regs_each_r_level %>% 
#   group_by(industry_name, ADMIN_AREA_NAME) %>% 
#   
#   slice_head(n = 1)
# 
# bc_regs = bc_regs %>% mutate(my_key = paste0(industry_name,ADMIN_AREA_NAME,max_restriction_value))
```

```{r load_in_provincial_summary_jpegs}
main_plot_f = image_read('out/forest_restriction_plot.jpeg') %>% 
  image_scale("x800") 
  # image_crop('900x700+0+250')

main_plot_m = image_read('out/mine_restriction_plot.jpeg') %>% 
  image_scale("x800")
  # image_crop('900x700+0+250')

main_plot_og = image_read('out/og_restriction_plot.jpeg') %>% 
  image_scale("x800")
  # image_crop('900x700+0+250')

# main_barplot_f = image_read('out/forestry_barplot.png') %>% 
# image_convert(format = 'jpeg') %>% 
# image_scale("x600")

# image_for_mosaic_f = c(main_plot_f,main_barplot_f)
# image_append(image_for_mosaic_f,stack=T)
```

```{r establish_crosstalk_shared_data_environments}
# shared_dat_f = crosstalk::SharedData$new(bc_regs %>% filter(industry_name == "forest_restriction_max"), key = ~my_key, group = 'all')
# 
# shared_dat_m = crosstalk::SharedData$new(bc_regs %>% filter(industry_name == "mine_restriction_max"), key = ~my_key)
# 
# shared_dat_og = crosstalk::SharedData$new(bc_regs %>% filter(industry_name == "og_restriction_max"), key = ~my_key)
# 
# shared_images_f = crosstalk::SharedData$new(bc_regs %>%
#                                               dplyr::select(my_key,image_path) %>%
#                                               st_drop_geometry(),
#                                             key = ~my_key)
```

Column {.tabset}
-----------------------------------------------------------------------

**Provincial Figures**

### Forestry

```{r}
main_plot_f
```

### Mining

```{r}
main_plot_m
```

### Oil and Gas

```{r}
main_plot_og
```

Column 
-------------------------------------------------------------------------

### Regional Districts - Click on the Region to See More Information
```{r regional_district_plot_plus_linked_histogram}
#Set up reactive, shared data environment.
bc_regs_for_plotly <- crosstalk::SharedData$new(bc_regs_wide)

# # Make a crosstalk filter for max restriction value.
# max_rlevel_selector = filter_select(
#   id = 'max_restriction_level_slider',
#   label = 'Restriction Level',
#   sharedData = bc_regs_for_plotly,
#   group = ~max_restriction_value,
#   multiple = F
# )

# initiate a plotly object
base <- bc_regs_for_plotly %>%
  plotly::plotly_empty()
  # highlight(
  #   on = 'plotly_click',
  #   off = 'plotly_doubleclick',
  #   opacityDim = 0.5
  # )

ggmap_plot = ggplot() +
  geom_sf(data = bc_regs_for_plotly,
          aes(text = ADMIN_AREA_NAME),
          fill = 'grey') +
  ggthemes::theme_map()
ggmap_plot = ggplotly(ggmap_plot, tooltip = 'ADMIN_AREA_NAME')

  # highlight(
  #   on = 'plotly_click',
  #   off = 'plotly_doubleclick',
  #   opacityDim = 0.5
  # )

# plotly_map = base %>%
#   # group_by(key) %>%
#   # add_scattergeo() %>%
#   highlight(
#     on = 'plotly_click',
#     off = 'plotly_doubleclick',
#     opacityDim = 0.5
#   )

plotly_barplot = bc_regs_for_plotly %>%
  plot_ly() %>%
  add_bars(x = ~max_restriction_0, y = 0, orientation = 'h', opacity = 0) %>%
  add_bars(x = ~max_restriction_1, y = 1, orientation = 'h', opacity = 0) %>%
  add_bars(x = ~max_restriction_2, y = 2, orientation = 'h', opacity = 0) %>%
  add_bars(x = ~max_restriction_3, y = 3, orientation = 'h', opacity = 0) %>%
  add_bars(x = ~max_restriction_4, y = 4, orientation = 'h', opacity = 0) %>%
  add_bars(x = ~max_restriction_5, y = 5, orientation = 'h', opacity = 0)
           # transforms = list(
           #   list(
           #     type = 'aggregate',
           #     groups = ~max_restriction_value,
           #     aggregations = list(
           #       list(
           #         target = 'x', func = 'sum', enabled = T
           #       )
           #     )
           #   )
           # )

subplot(ggmap_plot, plotly_barplot, nrows = 2) %>%
  layout(barmode = "overlay", showlegend = FALSE) %>%
  highlight(
    dynamic = TRUE,
    selectize = F,
    selected = attrs_selected(opacity = 0.9),
    color = 'rgba(152,78,163,1)'
  )
```

